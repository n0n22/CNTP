<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="moimMapper">
	
	<resultMap type="team" id="teamResultMap">
		<result column="TEAM_NO" 			property="teamNo"/>
		<result column="TEAM_NAME" 			property="teamName"/>
		<result column="MEM_NO" 			property="memNo"/>
		<result column="TEAM_MEMBER" 		property="teamMember"/>
		<result column="TEAM_INTRO" 		property="teamIntro"/>
		<result column="ORIGIN_NAME" 		property="originName"/>
		<result column="CHANGE_NAME" 		property="changeName"/>
		<result column="KOR_AREA" 			property="teamArea"/>
		<result column="TEAM_TIME" 			property="teamTime"/>
		<result column="KEYWORD" 			property="keyword"/>
		<result column="CREATE_DATE" 		property="createDate"/>
		<result column="BADGE_ORIGIN_NAME" 	property="badgeOriginName"/>
		<result column="BADGE_CHANGE_NAME" 	property="badgeChangeName"/>
		<result column="BADGE_STATUS" 		property="badgeStatus"/>
		<result column="STATUS" 			property="status"/>
		<result column="POWER_DURATION" 	property="powerDuration"/>
	</resultMap>
	
	<resultMap type="teamMember" id="teamMemberResultMap">
		<result column="TEAM_NO" 	property="teamNo"/>
		<result column="TEAM_GRADE" property="teamGrade"/>
		<result column="NICKNAME" 	property="nickname"/>
		<result column="MEM_NO" 	property="memNo"/>
		<result column="TEAM_ENROLL_DATE" 	property="teamEnrollDate"/>
	</resultMap>
	
	<resultMap type="group" id="groupResultMap">
		<result column="GROUP_NO" 			property="groupNo"/>
		<result column="MEM_NO" 			property="memNo"/>
		<result column="GROUP_TITLE" 		property="groupTitle"/>
		<result column="GROUP_CONTENT" 		property="groupContent"/>
		<result column="KOR_AREA" 		property="groupArea"/>
		<result column="PLACE" 				property="place"/>
		<result column="GROUP_MEMBER" 		property="groupMember"/>
		<result column="START_TIME" 		property="startTime"/>
		<result column="END_TIME" 			property="endTime"/>
		<result column="ORIGIN_NAME" 		property="originName"/>
		<result column="CHANGE_NAME" 		property="changeName"/>
		<result column="LEVEL" 				property="levle"/>
		<result column="GENDER" 			property="gender"/>
		<result column="CREATE_DATE" 		property="createDate"/>
		<result column="POWER_DURRATION" 	property="powerDuration"/>
	</resultMap>
	
	<resultMap type="apply" id="applyResultMap">
		<result column="APPLY_NO" 		property="applyNo"/>
		<result column="MOIM_NO" 		property="moimNo"/>
		<result column="NICKNAME" 		property="nickname"/>
		<result column="MEM_NO" 		property="memNo"/>
		<result column="ACCEPT_YN" 		property="acceptYn"/>
		<result column="APPLY_DATE" 	property="applyDate"/>
		<result column="ACCEPT_DATE" 	property="acceptDate"/>
	</resultMap>
	
	<resultMap type="chatting" id="chattingResultMap">
		<result column="CHAT_NO" 		property="chatNo"/>
		<result column="MOIM_NO" 		property="moimNo"/>
		<result column="MEM_NO" 		property="memNo"/>
		<result column="CHAT_CONTENT" 	property="chatContent"/>
		<result column="CREATE_DATE" 	property="createDate"/>
	</resultMap>
	
	<resultMap type="resultHistory" id="resultHistoryResultMap">
		<result column="TEAM_NO" 		property="teamNo"/>
		<result column="WINNING_STREAK" property="winningStreak"/>
		<result column="LOSING_STREAK" 	property="losingStreak"/>
		<result column="VICTORY" 		property="victory"/>
		<result column="DEFEAT" 		property="defeat"/>
	</resultMap>
	
	<select id="ajaxSelectTeam" resultType="_int" parameterType="string">
		SELECT
			   COUNT(*)
	      FROM
	           TEAM
	     WHERE
	     	   TEAM_NAME = #{ checkName }
	           
	</select>
	
	<insert id="insertTeam" parameterType="team">
		INSERT
		  INTO
		  	   TEAM
		VALUES
		       (
		        'T'||SEQ_TNO.NEXTVAL
		       ,#{ teamName }
		       ,#{ memNo }
		       ,#{ teamMember }
		       ,#{ teamIntro }
		       ,#{ originName }
		       ,#{ changeName }
		       ,#{ teamArea }
		       ,#{ teamTime }
		       ,#{ keyword }
		       ,SYSDATE
		       ,NULL
		       ,NULL
		       ,DEFAULT
		       ,DEFAULT
		       <if test="powerDuration != null">
		       ,SYSDATE + 7
		       </if>
		       <if test="powerDuration == null">
		       ,NULL
		       </if>
		       )
	</insert>
	
	<insert id="insertTeamLeaderMember" parameterType="team">
		INSERT
		  INTO
		       TEAM_MEMBER
		VALUES
		       (
		        'T'||SEQ_TNO.CURRVAL
		        ,'L'
		        ,#{ memNo }
		        ,SYSDATE
		       )
	</insert>
	
	<insert id="insertResultHistory">
		INSERT
		  INTO
		       RESULT_HISTORY
		VALUES
		       (
		        'T'||SEQ_TNO.CURRVAL
		        ,DEFAULT
		        ,DEFAULT
		        ,DEFAULT
		        ,DEFAULT
		       )
	</insert>
	
	<select id="selectTeam" parameterType="string" resultMap="teamResultMap">
		SELECT 
			   TEAM_NO
			  ,TEAM_NAME
			  ,MEM_NO
			  ,TEAM_MEMBER
			  ,TEAM_INTRO
			  ,ORIGIN_NAME
			  ,CHANGE_NAME
			  ,KOR_AREA
			  ,CASE WHEN TEAM_TIME = 'all' THEN '무관'
                    WHEN TEAM_TIME = 'weekday' THEN '평일'
                    ELSE '주말' END "TEAM_TIME"
			  ,CASE WHEN KEYWORD = 'social' THEN '친목'
                    WHEN KEYWORD = 'battle' THEN '배틀'
                    ELSE '온라인모임만' END "KEYWORD"
			  ,TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "CREATE_DATE"
			  ,BADGE_ORIGIN_NAME
			  ,BADGE_CHANGE_NAME
			  ,BADGE_STATUS
			  ,STATUS
			  ,POWER_DURATION
	     FROM
	          TEAM "T"
	     JOIN
	          AREA "A" ON(T.TEAM_AREA = A.ENG_AREA)
		WHERE
		      TEAM_NO = #{ teamNo }
		  AND
		       STATUS = 'Y'
	</select>
	
	<select id="selectTeamMeberList" resultMap="teamMemberResultMap" parameterType="string">
		SELECT
		         TM.TEAM_NO
		        ,CASE WHEN TEAM_GRADE = 'L' THEN '팀장'
		              WHEN TEAM_GRADE = 'S' THEN '부팀장'
		              ELSE '팀원' END "TEAM_GRADE"
		        ,M.NICKNAME
		        ,TM.MEM_NO
		        ,TO_CHAR(TEAM_ENROLL_DATE, 'YYYY-MM-DD') AS "TEAM_ENROLL_DATE"
		  FROM 
		       TEAM_MEMBER "TM"
		  JOIN
		       TEAM "T" ON(TM.TEAM_NO = T.TEAM_NO)
		  JOIN
		       MEMBER "M" ON(TM.MEM_NO = M.MEM_NO)
		 WHERE
		       T.TEAM_NO = #{ teamNo }
		   AND
		       T.STATUS = 'Y'
		 ORDER
		    BY
		       (CASE WHEN TEAM_GRADE = '팀장' THEN 1
		            WHEN TEAM_GRADE = '부팀장' THEN 2
		            ELSE 3 END), "TEAM_GRADE"
			   
	</select>
	
	<select id="selectApplyList" resultMap="applyResultMap" parameterType="string">
		SELECT
		        A.APPLY_NO
		       ,A.MOIM_NO
		       ,M.NICKNAME
		       ,A.MEM_NO
		       ,A.ACCEPT_YN
		       ,TO_CHAR(APPLY_DATE, 'YYYY-MM-DD') AS "APPLY_DATE"
		       ,TO_CHAR(ACCEPT_DATE, 'YYYY-MM-DD') AS "ACCEPT_DATE"
		  FROM
		       APPLY "A"
		  JOIN
		       TEAM "T" ON(A.MOIM_NO = T.TEAM_NO)
		  JOIN
		       MEMBER "M" ON(A.MEM_NO = M.MEM_NO)
		 WHERE
		       MOIM_NO = #{ moimNo }
		   AND
		       T.STATUS = 'Y'
		   AND
		       A.ACCEPT_YN = 'N'
		   
	</select>
	
	<select id="selectResultHistory" parameterType="string" resultMap="resultHistoryResultMap">
		SELECT
		        R.TEAM_NO
		       ,R.WINNING_STREAK
		       ,R.LOSING_STREAK
		       ,R.VICTORY
		       ,R.DEFEAT
		  FROM
		       RESULT_HISTORY "R"
		  JOIN
		       TEAM "T" ON(T.TEAM_NO = R.TEAM_NO)
		WHERE
		       R.TEAM_NO = #{ teamNo }
		  AND
		       T.STATUS = 'Y'
	</select>
	
	<select id="ajaxSelectApply" parameterType="_int" resultMap="applyResultMap">
		SELECT
			    APPLY_NO
			   ,MOIM_NO
			   ,ACCEPT_YN
			   ,APPLY_DATE
			   ,ACCEPT_DATE
		  FROM
		       APPLY
		 WHERE
		       MEM_NO = #{ memNo }
           AND
               MOIM_NO LIKE 'T%'
	</select>

	<update id="updateTeam" parameterType="team">
		UPDATE
		       TEAM
		   SET TEAM_MEMBER = #{ teamMember }
		      ,TEAM_INTRO = #{ teamIntro }
		      ,ORIGIN_NAME = #{ originName }
		      ,CHANGE_NAME = #{ changeName }
		      ,TEAM_AREA = #{ teamArea }
		      ,TEAM_TIME = #{ teamTime }
		      ,KEYWORD = #{ keyword }
		      ,BADGE_ORIGIN_NAME = #{ badgeOriginName }
		      ,BADGE_CHANGE_NAME = #{ badgeChangeName }
		      <if test="powerDuration == 'true'">
		      	,POWER_DURATION = SYSDATE + 7
		      </if>
		 WHERE
		       TEAM_NO =  #{ teamNo }
	</update>	
	
	<update id="updateTeamBadgeStatus" parameterType="team">
		UPDATE TEAM
		   SET BADGE_STATUS = 'Y'
		 WHERE TEAM_NO = #{ teamNo }
	</update>
	
	<update id="updateTeamMember" parameterType="teamMember">
		UPDATE
		       TEAM_MEMBER
		   SET
		       TEAM_GRADE = #{ teamGrade }
		 WHERE
		       MEM_NO = #{ memNo }
	</update>
	
</mapper>
